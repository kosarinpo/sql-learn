For each ship from the Ships table, determine the name of the earliest battle
from the Battles table it could have participated in after being launched.
If the year the ship has been launched is unknown use the latest battle.
If no battles occurred after the ship was launched, display NULL instead of the battle name.
Itâ€™s assumed a ship can participate in any battle fought in the year of its launching.
Result set: name of the ship, year it was launched, name of battle.

Note: assume there are no battles fought at the same day.
WITH
    BattlesYY AS
        (
            SELECT DISTINCT
                DATEPART(yy, Battles.date) AS date
              , Battles.name as name
            FROM
                Battles
        )
SELECT DISTINCT
    Ships.name AS name
  , Ships.launched
  , CASE
        WHEN
            Ships.launched >=
                (
                    SELECT
                        MAX(BattlesYY.date)
                    FROM
                        BattlesYY
                )
            THEN
                NULL
        ELSE
            BattlesYY.name
    END AS battle
FROM
    Ships
    CROSS JOIN
        BattlesYY
WHERE
    (
        Ships.launched IS NOT NULL
        AND
        (
            (
                BattlesYY.date >= Ships.launched
                AND
                NOT EXISTS
                    (
                        SELECT
                            Battles2.date
                        FROM
                            BattlesYY AS Battles2
                        WHERE
                            Battles2.date >= Ships.launched
                            AND
                            Battles2.date < BattlesYY.date

                    )
            )
            OR
            Ships.launched >=
                (
                    SELECT
                        MAX(BattlesYY.date)
                    FROM
                        BattlesYY
                )
        )
    )
    OR
    (
        Ships.launched IS NULL
        AND
        BattlesYY.date IN
            (
                SELECT
                    MAX(BattlesYY.date)
                FROM
                    BattlesYY
            )
    )
